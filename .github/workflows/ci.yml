name: CI

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image inside Minikube
        run: |
          eval $(minikube -p minikube docker-env)
          # Use the exact same name/tag format that K8s expects
          docker build -t todo-app:${{ github.sha }} .
          docker tag todo-app:${{ github.sha }} todo-app:latest

          # 2. Build the image with the unique GitHub SHA tag
          docker build -t todo-app:${{ github.sha }} .
          
          # 3. Also tag it as latest for record keeping
          docker tag todo-app:${{ github.sha }} todo-app:latest

      - name: Apply Kubernetes Configs
        run: |
          kubectl apply -f k8s-deployment.yaml
          kubectl apply -f k8s-service.yaml

      - name: Deploy New Image to Cluster
        run: |
          # 4. Explicitly update the deployment to use the new SHA-tagged image.
          # This is the "magic" command that forces Kubernetes to trigger a rolling update.
          kubectl set image deployment/todo-deployment todo-container=todo-app:${{ github.sha }}

      - name: Verify Deployment
        run: |
          # 5. Wait for the rollout to finish to ensure it's successful
          kubectl rollout status deployment/todo-deployment
